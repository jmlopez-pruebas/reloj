<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reloj de Pantalla Completa</title>
    <link rel="icon" type="image/png" href="https://i.ibb.co/C3VyynFN/reloj.png"/>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Archivo+Black&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Anton&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            transition: background-image 0.5s ease-in-out;
        }
        input[type='number']::-webkit-inner-spin-button,
        input[type='number']::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .toggle-checkbox:checked + .toggle-bg {
            background-color: #3b82f6;
            border-color: #3b82f6;
        }
        .toggle-checkbox:checked + .toggle-bg:after {
            transform: translateX(100%);
            border-color: white;
        }
        .toggle-bg {
            width: 3.5rem;
            height: 2rem;
            transition: background-color 0.2s ease-in-out;
        }
        .toggle-bg:after {
            content: '';
            position: absolute;
            top: 0.25rem;
            left: 0.25rem;
            width: 1.5rem;
            height: 1.5rem;
            background-color: white;
            border-radius: 9999px;
            border: 2px solid #e5e7eb;
            transition: transform 0.2s ease-in-out;
        }
        .config-select {
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            color: white;
            width: 100%;
        }
        .config-select option {
            background-color: #333;
            color: white;
        }
        .alt-bg-input-group {
            display: flex;
            align-items: center;
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 0.375rem;
            width: 100%;
        }
        .alt-bg-input-group input[type="text"] {
            flex-grow: 1;
            background: transparent;
            border: none;
            padding: 0.5rem 0.75rem;
            color: white;
            min-width: 0;
        }
        .alt-bg-input-group input[type="text"]::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }
        .alt-bg-input-group input[type="file"] {
            display: none;
        }
        .alt-bg-input-group label {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            border-left: 1px solid rgba(255, 255, 255, 0.3);
            color: rgba(255, 255, 255, 0.7);
        }
        .alt-bg-input-group label:hover {
            color: white;
        }
        .alt-bg-input-group .clear-alt-bg {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            border-left: 1px solid rgba(255, 255, 255, 0.3);
            color: rgba(255, 255, 255, 0.7);
            font-size: 1.25rem;
            line-height: 1;
        }
        .alt-bg-input-group .clear-alt-bg:hover {
            color: white;
        }
        /* Slider styling */
        input[type=range] {
            -webkit-appearance: none; 
            background: transparent; 
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #ffffff;
            cursor: pointer;
            margin-top: -6px; 
            box-shadow: 0 0 2px rgba(0,0,0,0.5);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: rgba(255,255,255,0.3);
            border-radius: 2px;
        }
    </style>
</head>
<body class="bg-black text-white h-screen w-screen overflow-hidden flex items-center justify-center relative transition-all duration-500" id="main-body">

    <div id="weather-display" class="absolute top-14 left-1/2 -translate-x-1/2 text-4xl sm:text-5xl md:text-6xl font-bold opacity-70 z-10 hidden transition-transform duration-200 whitespace-nowrap tracking-wide flex items-center gap-3 origin-top" style="text-shadow: 0 2px 10px rgba(0,0,0,0.3);">
        </div>

    <div id="clock-container" class="flex flex-col items-center justify-center text-center transition-transform duration-200 origin-center">
        <div id="date-display" class="text-2xl sm:text-3xl md:text-4xl opacity-70 mb-4" style="font-family: 'Inter', sans-serif;">
            Cargando fecha...
        </div>
        
        <div class="flex items-baseline justify-center whitespace-nowrap">
            <div id="time-display" class="font-bold text-[12rem] sm:text-[14rem] md:text-[18rem] lg:text-[24rem] leading-none opacity-70">
                00:00
            </div>
            <div id="seconds-display" class="font-bold text-3xl sm:text-4xl md:text-5xl lg:text-7xl leading-none opacity-70 pl-2 sm:pl-4 md:pl-6">
                :00
            </div>
        </div>
    </div>

    <button id="settings-btn" class="absolute top-6 right-6 p-3 text-white opacity-50 hover:opacity-100 transition-opacity z-20">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-sliders-horizontal"><line x1="21" x2="14" y1="4" y2="4"/><line x1="10" x2="3" y1="4" y2="4"/><line x1="21" x2="12" y1="12" y2="12"/><line x1="8" x2="3" y1="12" y2="12"/><line x1="21" x2="16" y1="20" y2="20"/><line x1="12" x2="3" y1="20" y2="20"/><line x1="14" x2="14" y1="2" y2="6"/><line x1="8" x2="8" y1="10" y2="14"/><line x1="16" x2="16" y1="18" y2="22"/></svg>
    </button>
    
    <button id="fullscreen-btn" class="absolute top-6 left-6 p-3 text-white opacity-50 hover:opacity-100 transition-all duration-300 z-20">
      <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-expand"><path d="m21 21-6-6m6 6v-4.8m0 4.8h-4.8"/><path d="M3 16.2V21h4.8"/><path d="M3 12.6V7.8A4.8 4.8 0 0 1 7.8 3h4.8"/><path d="M16.2 3H21v4.8"/></svg>
    </button>

    <div id="app-links" class="absolute bottom-10 left-1/2 -translate-x-1/2 flex space-x-4 z-10 transition-transform duration-200 origin-bottom">
        <a href="https://www.espana.fm/" target="_blank" class="px-3 py-1 bg-white/10 border border-white/20 rounded-lg text-xs font-medium opacity-70 hover:opacity-100 transition-all">
            Abrir Radio FM
        </a>
        <a href="spotify:" class="px-3 py-1 bg-white/10 border border-white/20 rounded-lg text-xs font-medium opacity-70 hover:opacity-100 transition-all">
            Abrir Spotify
        </a>
    </div>

    <div id="settings-panel" class="absolute inset-0 w-full h-full bg-black/70 flex items-center justify-center p-6 z-30 hidden backdrop-blur-md overflow-y-auto">
        <div class="bg-white/10 border border-white/20 text-white p-6 sm:p-8 rounded-2xl shadow-2xl w-full max-w-md relative backdrop-blur-lg my-auto">
            <button id="close-panel-btn" class="absolute top-4 right-4 text-gray-300 hover:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
            </button>
            
            <h2 class="text-2xl font-bold mb-6">Configuración</h2>

            <div class="space-y-4 mb-6">
                <h3 class="text-sm font-semibold text-gray-300 uppercase">Formato de Hora</h3>
                <div class="flex items-center justify-between">
                    <label for="show-seconds-toggle" class="font-medium">Mostrar segundos</label>
                    <input type="checkbox" id="show-seconds-toggle" class="toggle-checkbox hidden">
                    <label for="show-seconds-toggle" class="toggle-bg relative inline-block bg-gray-600 border-2 border-transparent rounded-full cursor-pointer"></label>
                </div>
                <div class="flex items-center justify-between">
                    <label for="hour-format-toggle" class="font-medium">Formato 24 horas</label>
                    <input type="checkbox" id="hour-format-toggle" class="toggle-checkbox hidden">
                    <label for="hour-format-toggle" class="toggle-bg relative inline-block bg-gray-600 border-2 border-transparent rounded-full cursor-pointer"></label>
                </div>
            </div>

            <hr class="border-white/20 my-6">

            <div class="space-y-4 mb-6">
                <h3 class="text-sm font-semibold text-gray-300 uppercase">Tamaño de Elementos</h3>
                
                <div>
                    <div class="flex justify-between mb-1">
                        <label for="clock-scale-input" class="text-sm font-medium">Reloj</label>
                        <span id="clock-scale-value" class="text-xs text-gray-400">100%</span>
                    </div>
                    <input type="range" id="clock-scale-input" min="0.3" max="2.5" step="0.05" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
                </div>

                <div>
                    <div class="flex justify-between mb-1">
                        <label for="weather-scale-input" class="text-sm font-medium">Clima</label>
                        <span id="weather-scale-value" class="text-xs text-gray-400">100%</span>
                    </div>
                    <input type="range" id="weather-scale-input" min="0.5" max="2.0" step="0.05" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
                </div>

                <div>
                    <div class="flex justify-between mb-1">
                        <label for="apps-scale-input" class="text-sm font-medium">Botones Apps</label>
                        <span id="apps-scale-value" class="text-xs text-gray-400">100%</span>
                    </div>
                    <input type="range" id="apps-scale-input" min="0.5" max="2.5" step="0.05" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
                </div>
                
                <button id="reset-scales-btn" class="text-xs text-blue-400 hover:text-blue-300 mt-2">Restablecer tamaños originales</button>
            </div>

            <hr class="border-white/20 my-6">

            <div class="space-y-4 mb-6">
                <h3 class="text-sm font-semibold text-gray-300 uppercase">Clima y Ubicación</h3>
                <div class="flex items-center justify-between">
                    <label for="show-weather-toggle" class="font-medium">Mostrar Temperatura</label>
                    <input type="checkbox" id="show-weather-toggle" class="toggle-checkbox hidden">
                    <label for="show-weather-toggle" class="toggle-bg relative inline-block bg-gray-600 border-2 border-transparent rounded-full cursor-pointer"></label>
                </div>
                
                <div id="weather-input-container" class="space-y-2 hidden">
                    <label class="block text-sm font-medium text-gray-200">Ciudad / Localización</label>
                    <div class="flex space-x-2">
                        <input type="text" id="weather-city-input" placeholder="Ej: Madrid, Buenos Aires" class="flex-1 w-full px-3 py-2 border border-white/30 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white/10 text-white placeholder-gray-400">
                        <button id="update-weather-btn" class="px-3 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 font-medium text-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                        </button>
                    </div>
                    <p id="weather-status-msg" class="text-xs text-gray-400 min-h-[1rem]"></p>
                </div>
            </div>

            <hr class="border-white/20 my-6">

            <div class="space-y-4 mb-6">
                <h3 class="text-sm font-semibold text-gray-300 uppercase">Estilo del Reloj</h3>
                <div class="flex items-center justify-between">
                    <label for="text-color-picker" class="font-medium">Color del texto</label>
                    <div class="flex items-center space-x-2">
                        <button id="reset-color-btn" class="text-xs text-gray-300 hover:text-white">Restablecer</button>
                        <input type="color" id="text-color-picker" class="w-10 h-10 p-0 border-none rounded cursor-pointer bg-transparent" value="#FFFFFF">
                    </div>
                </div>
                <div class="flex items-center justify-between">
                      <label for="font-select" class="font-medium">Fuente del reloj</label>
                </div>
                <select id="font-select" class="config-select">
                    <option value="'Inter', sans-serif">Moderno (Inter)</option>
                    <option value="'Oswald', sans-serif">Condensado (Oswald)</option>
                    <option value="'Archivo Black', sans-serif">Impacto (Archivo)</option>
                    <option value="'Montserrat', sans-serif">Geométrico (Montserrat)</option>
                    <option value="'Bebas Neue', cursive">Alto (Bebas Neue)</option>
                    <option value="'Anton', sans-serif">Fuerte (Anton)</option>
                </select>
            </div>

            <hr class="border-white/20 my-6">

            <div class="space-y-4 mb-6">
                <h3 class="text-sm font-semibold text-gray-300 uppercase">Fondos Alternos</h3>
                <div class="flex items-center justify-between">
                    <label for="alt-bg-toggle" class="font-medium">Activar fondos alternos</label>
                    <input type="checkbox" id="alt-bg-toggle" class="toggle-checkbox hidden">
                    <label for="alt-bg-toggle" class="toggle-bg relative inline-block bg-gray-600 border-2 border-transparent rounded-full cursor-pointer"></label>
                </div>
                <div id="alt-bg-inputs-container" class="hidden space-y-2 pt-2 max-h-48 overflow-y-auto pr-2">
                    <label class="text-xs text-gray-300">Añade URLs o sube archivos (rotan cada 10 min):</label>
                    <p class="text-xs text-yellow-400/80 my-1">Nota: Los archivos subidos de más de 2-3MB pueden no guardarse al recargar.</p>
                </div>
            </div>

            <hr class="border-white/20 my-6">

            <div class="space-y-4">
                <h3 class="text-sm font-semibold text-gray-300 uppercase">Fondo Manual</h3>
                <div class="pt-2">
                    <label class="block text-sm font-medium text-gray-200 mb-2">Fondo por URL</label>
                    <div class="flex space-x-2">
                        <input type="text" id="bg-url-input" placeholder="Pegar URL de la imagen" class="flex-1 w-full px-3 py-2 border border-white/30 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white/10 text-white placeholder-gray-400">
                        <button id="set-bg-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 font-medium">Usar</button>
                    </div>
                </div>

                <div>
                    <label for="bg-file-input" class="block text-sm font-medium text-gray-200 mb-2">...o subir desde el dispositivo:</label>
                    <input type="file" id="bg-file-input" accept="image/*" class="block w-full text-sm text-gray-300
                        file:mr-4 file:py-2 file:px-4
                        file:rounded-md file:border-0
                        file:text-sm file:font-semibold
                        file:bg-white/20 file:text-white
                        hover:file:bg-white/30 cursor-pointer
                    "/>
                    <p class="text-xs text-yellow-400/80 mt-1">Nota: Archivos muy grandes ( > 5MB) pueden no guardarse al recargar.</p>
                </div>
                
                <button id="reset-bg-btn" class="w-full mt-2 px-4 py-2 bg-white/20 text-white rounded-md hover:bg-white/30">Quitar fondo (Negro)</button>
            </div>
            
        </div>
    </div>

    <script>
    const timeDisplay = document.getElementById('time-display');
    const secondsDisplay = document.getElementById('seconds-display');
    const dateDisplay = document.getElementById('date-display');
    const weatherDisplay = document.getElementById('weather-display');
    const mainBody = document.getElementById('main-body');
    const clockContainer = document.getElementById('clock-container');
    const appLinks = document.getElementById('app-links');
        
    const settingsBtn = document.getElementById('settings-btn');
    const fullscreenBtn = document.getElementById('fullscreen-btn');
    const settingsPanel = document.getElementById('settings-panel');
    const closePanelBtn = document.getElementById('close-panel-btn');
        
    const bgUrlInput = document.getElementById('bg-url-input');
    const setBgBtn = document.getElementById('set-bg-btn');
    const bgFileInput = document.getElementById('bg-file-input');
    const resetBgBtn = document.getElementById('reset-bg-btn');

    const showSecondsToggle = document.getElementById('show-seconds-toggle');
    const hourFormatToggle = document.getElementById('hour-format-toggle');
    const textColorPicker = document.getElementById('text-color-picker');
    const resetColorBtn = document.getElementById('reset-color-btn');
    const fontSelect = document.getElementById('font-select');

    // Scale Controls
    const clockScaleInput = document.getElementById('clock-scale-input');
    const clockScaleValue = document.getElementById('clock-scale-value');
    const weatherScaleInput = document.getElementById('weather-scale-input');
    const weatherScaleValue = document.getElementById('weather-scale-value');
    const appsScaleInput = document.getElementById('apps-scale-input');
    const appsScaleValue = document.getElementById('apps-scale-value');
    const resetScalesBtn = document.getElementById('reset-scales-btn');

    const showWeatherToggle = document.getElementById('show-weather-toggle');
    const weatherInputContainer = document.getElementById('weather-input-container');
    const weatherCityInput = document.getElementById('weather-city-input');
    const updateWeatherBtn = document.getElementById('update-weather-btn');
    const weatherStatusMsg = document.getElementById('weather-status-msg');

    const altBgToggle = document.getElementById('alt-bg-toggle');
    const altBgInputsContainer = document.getElementById('alt-bg-inputs-container');

    let altBgInterval = null;
    let currentAltBgIndex = 0;

    const defaultSettings = {
        bgUrl: null,
        textColor: '#FFFFFF',
        showSeconds: true,
        is24Hour: true,
        fontFamily: "'Inter', sans-serif",
        useAlternatingBgs: false,
        showWeather: false,
        weatherCity: '',
        alternatingBgSources: Array(10).fill({ type: null, value: null }),
        // Nuevas propiedades de escala
        clockScale: 1.0,
        weatherScale: 1.0,
        appsScale: 1.0
    };
    let settings = { ...defaultSettings };

    const dateOptions = {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    };

    function updateClock() {
        const now = new Date();
        let hours = now.getHours();
        const minutes = now.getMinutes().toString().padStart(2, '0');
        const seconds = now.getSeconds().toString().padStart(2, '0');
        let mainTimeString = '';
        const secondsString = `:${seconds}`;

        if (settings.is24Hour) {
                mainTimeString = `${hours.toString().padStart(2, '0')}:${minutes}`;
        } else {
            const ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12;
            hours = hours ? hours : 12;
            mainTimeString = `${hours}:${minutes} ${ampm}`;
        }
        timeDisplay.textContent = mainTimeString;
        secondsDisplay.textContent = secondsString;

        const dateString = (now.toLocaleDateString('es-ES', dateOptions)).replace(/^\w/, (c) => c.toUpperCase());
        if (dateDisplay.textContent !== dateString) {
            dateDisplay.textContent = dateString;
        }
    }
        
        // --- HELPERS PARA ICONOS DE CLIMA (WMO codes) ---
        function getWeatherIcon(code) {
            const icons = {
                sun: `<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>`,
                cloud: `<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.5 19c0-1.7-1.3-3-3-3h-1.1c-.1-1.3-.8-2.5-1.9-3.4C10.5 11.7 9.1 12 8 13c0 0 0 0 0 0-1.6 0-3 1.3-3 3 0 0 0 0 0 0 0 1.7 1.3 3 3 3h9.5c1.7 0 3-1.3 3-3Z"/><path d="M17 12c.5-2.2 2.5-4 4.8-4 .1 0 .3 0 .4.1"/><path d="M11.6 9a5 5 0 0 1 10 3.4"/></svg>`,
                partlyCloudy: `<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="M20 12h2"/><path d="m19.07 4.93-1.41 1.41"/><path d="M15.947 12.65a4 4 0 0 0-5.925-4.128"/><path d="M13 22H7a5 5 0 1 1 4.9-6H13a3 3 0 0 1 0 6Z"/></svg>`,
                rain: `<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M16 14v6"/><path d="M8 14v6"/><path d="M12 16v6"/></svg>`,
                snow: `<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M8 15h.01"/><path d="M8 19h.01"/><path d="M12 17h.01"/><path d="M12 21h.01"/><path d="M16 15h.01"/><path d="M16 19h.01"/></svg>`,
                thunder: `<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 16.326A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 .5 8.973"/><path d="m13 12-3 5h4l-3 5"/></svg>`,
                fog: `<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 15h16"/><path d="M4 20h16"/><path d="M6 10h12"/><path d="M8 5h8"/></svg>`
            };

            if (code === 0) return icons.sun;
            if (code >= 1 && code <= 3) return icons.partlyCloudy;
            if (code === 45 || code === 48) return icons.fog;
            if ((code >= 51 && code <= 67) || (code >= 80 && code <= 82)) return icons.rain;
            if ((code >= 71 && code <= 77) || (code >= 85 && code <= 86)) return icons.snow;
            if (code >= 95) return icons.thunder;
            return icons.cloud; 
        }

        async function fetchWeather() {
            if (!settings.weatherCity || !settings.showWeather) return;

            weatherStatusMsg.textContent = "Buscando...";
            
            try {
                const geoUrl = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(settings.weatherCity)}&count=1&language=es&format=json`;
                const geoRes = await fetch(geoUrl);
                const geoData = await geoRes.json();

                if (!geoData.results || geoData.results.length === 0) {
                    weatherStatusMsg.textContent = "Ciudad no encontrada.";
                    weatherDisplay.textContent = "--";
                    return;
                }

                const { latitude, longitude, name } = geoData.results[0];

                const weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current=temperature_2m,weathercode&timezone=auto`;
                const weatherRes = await fetch(weatherUrl);
                const weatherData = await weatherRes.json();

                const temp = Math.round(weatherData.current.temperature_2m);
                const code = weatherData.current.weathercode;
                
                const iconSvg = getWeatherIcon(code);
                
                weatherDisplay.innerHTML = `<span>${temp}°C</span> <div class="w-[1em] h-[1em] flex items-center justify-center">${iconSvg}</div>`;
                
                weatherStatusMsg.textContent = `Localización encontrada: ${temp}°C en ${name}`;
                weatherStatusMsg.classList.add('text-green-400');
                
            } catch (error) {
                console.error("Error al obtener clima:", error);
                weatherStatusMsg.textContent = "Error.";
                weatherDisplay.innerHTML = "--°C";
            }
        }

        function getDarkenedBackground(imageUrl) {
            if (!imageUrl) return 'none';
            return `linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.4)), url(${imageUrl})`;
        }

        function stopAlternatingBackgrounds() {
            if (altBgInterval) {
                clearInterval(altBgInterval);
                altBgInterval = null;
            }
        }

        function setNextAlternatingBg(validSources) {
            if (validSources.length === 0) {
                mainBody.style.backgroundImage = 'none';
                return;
            }
            const source = validSources[currentAltBgIndex];
            mainBody.style.backgroundImage = getDarkenedBackground(source.value);
            mainBody.style.backgroundSize = 'cover';
            mainBody.style.backgroundPosition = 'center';
            currentAltBgIndex = (currentAltBgIndex + 1) % validSources.length;
        }

        function startAlternatingBackgrounds() {
            stopAlternatingBackgrounds();
            const validSources = settings.alternatingBgSources.filter(src => src && src.value);
            setNextAlternatingBg(validSources);
            if (validSources.length > 0) {
                altBgInterval = setInterval(() => setNextAlternatingBg(validSources), 10 * 60 * 1000);
            }
        }

        function saveSettings() {
            try {
                // Actualizar versión para manejar nuevas propiedades
                localStorage.setItem('clockSettingsV17', JSON.stringify(settings)); 
            } catch (e) {
                console.error("Error al guardar la configuración:", e);
            }
        }

        function applySettings() {
            clockContainer.style.color = settings.textColor;
            weatherDisplay.style.color = settings.textColor; 

            timeDisplay.style.fontFamily = settings.fontFamily;
            secondsDisplay.style.fontFamily = settings.fontFamily;
            dateDisplay.style.fontFamily = settings.fontFamily;
            weatherDisplay.style.fontFamily = settings.fontFamily;

            secondsDisplay.style.display = settings.showSeconds ? 'block' : 'none';

            // APLICAR ESCALAS
            // El reloj está en flujo normal, usamos scale
            clockContainer.style.transform = `scale(${settings.clockScale})`;
            
            // El clima es absoluto y centrado (-translate-x-1/2), debemos mantener eso en el transform
            weatherDisplay.style.transform = `translateX(-50%) scale(${settings.weatherScale})`;
            
            // Los botones son absolutos y centrados
            appLinks.style.transform = `translateX(-50%) scale(${settings.appsScale})`;

            if (settings.showWeather) {
                weatherDisplay.classList.remove('hidden');
                weatherInputContainer.classList.remove('hidden');
                if (settings.weatherCity) {
                    if (!weatherDisplay.innerHTML.includes('°C')) {
                        fetchWeather();
                    }
                } else {
                    weatherDisplay.textContent = "Configure la localización para mostrar el clima.";
                }
            } else {
                weatherDisplay.classList.add('hidden');
                weatherInputContainer.classList.add('hidden');
            }

            if (settings.useAlternatingBgs) {
                startAlternatingBackgrounds();
            } else {
                stopAlternatingBackgrounds();
                mainBody.style.backgroundImage = getDarkenedBackground(settings.bgUrl);
                mainBody.style.backgroundSize = 'cover';
                mainBody.style.backgroundPosition = 'center';
            }
            updateClock();
        }

        function loadSettings() {
            // Intentamos cargar la versión nueva, si no existe, probamos la vieja
            let savedSettings = localStorage.getItem('clockSettingsV17');
            if (!savedSettings) {
                 savedSettings = localStorage.getItem('clockSettingsV16');
            }

            if (savedSettings) {
                settings = { ...defaultSettings, ...JSON.parse(savedSettings) };
                settings.alternatingBgSources = (settings.alternatingBgSources || Array(10).fill({ type: null, value: null })).concat(Array(10).fill({ type: null, value: null })).slice(0, 10);
            }
            
            showSecondsToggle.checked = settings.showSeconds;
            hourFormatToggle.checked = settings.is24Hour;
            textColorPicker.value = settings.textColor;
            fontSelect.value = settings.fontFamily;

            // Cargar valores de escalas en los inputs
            clockScaleInput.value = settings.clockScale;
            clockScaleValue.innerText = Math.round(settings.clockScale * 100) + '%';
            
            weatherScaleInput.value = settings.weatherScale;
            weatherScaleValue.innerText = Math.round(settings.weatherScale * 100) + '%';

            appsScaleInput.value = settings.appsScale;
            appsScaleValue.innerText = Math.round(settings.appsScale * 100) + '%';


            showWeatherToggle.checked = settings.showWeather;
            weatherCityInput.value = settings.weatherCity || '';

            if (settings.bgUrl && !settings.bgUrl.startsWith('data:')) {
                bgUrlInput.value = settings.bgUrl;
            }

            altBgToggle.checked = settings.useAlternatingBgs;
            if (settings.useAlternatingBgs) {
                altBgInputsContainer.classList.remove('hidden');
            } else {
                altBgInputsContainer.classList.add('hidden');
            }
            generateAltBgInputs();
            applySettings();
        }

        function generateAltBgInputs() {
            altBgInputsContainer.innerHTML = `
                <label class="text-xs text-gray-300">Añade URLs o sube archivos (rotan cada 10 min):</label>
                <p class="text-xs text-yellow-400/80 my-1">Nota: Los archivos subidos de más de 2-3MB pueden no guardarse al recargar.</p>
            `;
            
            for (let i = 0; i < 10; i++) {
                const source = settings.alternatingBgSources[i] || { type: null, value: null };
                const group = document.createElement('div');
                group.className = 'alt-bg-input-group';
                group.dataset.index = i;

                const urlInput = document.createElement('input');
                urlInput.type = 'text';
                urlInput.placeholder = `URL de imagen ${i + 1}`;
                urlInput.className = 'alt-bg-url';
                if (source.type === 'url') {
                    urlInput.value = source.value;
                }
                
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.id = `alt-bg-file-${i}`;
                fileInput.className = 'alt-bg-file';
                fileInput.accept = 'image/*';

                const fileLabel = document.createElement('label');
                fileLabel.htmlFor = `alt-bg-file-${i}`;
                fileLabel.title = 'Subir archivo';
                fileLabel.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>`;
                
                const clearBtn = document.createElement('span');
                clearBtn.className = 'clear-alt-bg';
                clearBtn.title = 'Borrar entrada';
                clearBtn.innerHTML = '&times;';

                if (source.type === 'data') {
                    urlInput.value = 'Archivo subido (local)';
                    urlInput.disabled = true;
                }

                urlInput.addEventListener('change', (e) => {
                    const value = e.target.value.trim();
                    if (value) {
                        settings.alternatingBgSources[i] = { type: 'url', value: value };
                    } else {
                        settings.alternatingBgSources[i] = { type: null, value: null };
                    }
                    saveSettings();
                    if (settings.useAlternatingBgs) applySettings();
                });

                fileInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (re) => {
                            settings.alternatingBgSources[i] = { type: 'data', value: re.target.result };
                            urlInput.value = 'Archivo subido (local)';
                            urlInput.disabled = true;
                            saveSettings();
                            if (settings.useAlternatingBgs) applySettings();
                        };
                        reader.readAsDataURL(file);
                    }
                });

                clearBtn.addEventListener('click', () => {
                    settings.alternatingBgSources[i] = { type: null, value: null };
                    urlInput.value = '';
                    urlInput.disabled = false;
                    fileInput.value = null;
                    saveSettings();
                    if (settings.useAlternatingBgs) applySettings();
                });

                group.appendChild(urlInput);
                group.appendChild(fileInput);
                group.appendChild(fileLabel);
                group.appendChild(clearBtn);
                altBgInputsContainer.appendChild(group);
            }
        }

        // --- Event Listeners UI ---

        settingsBtn.addEventListener('click', () => settingsPanel.classList.remove('hidden'));
        closePanelBtn.addEventListener('click', () => settingsPanel.classList.add('hidden'));

        showSecondsToggle.addEventListener('change', () => {
            settings.showSeconds = showSecondsToggle.checked;
            applySettings();
            saveSettings();
        });

        hourFormatToggle.addEventListener('change', () => {
            settings.is24Hour = hourFormatToggle.checked;
            applySettings();
            saveSettings();
        });

        // --- Event Listeners Scales ---
        
        // Reloj
        clockScaleInput.addEventListener('input', (e) => {
            settings.clockScale = parseFloat(e.target.value);
            clockScaleValue.innerText = Math.round(settings.clockScale * 100) + '%';
            applySettings();
        });
        clockScaleInput.addEventListener('change', saveSettings); // Guardar al soltar

        // Clima
        weatherScaleInput.addEventListener('input', (e) => {
            settings.weatherScale = parseFloat(e.target.value);
            weatherScaleValue.innerText = Math.round(settings.weatherScale * 100) + '%';
            applySettings();
        });
        weatherScaleInput.addEventListener('change', saveSettings);

        // Apps
        appsScaleInput.addEventListener('input', (e) => {
            settings.appsScale = parseFloat(e.target.value);
            appsScaleValue.innerText = Math.round(settings.appsScale * 100) + '%';
            applySettings();
        });
        appsScaleInput.addEventListener('change', saveSettings);

        // Reset Scales
        resetScalesBtn.addEventListener('click', () => {
            settings.clockScale = 1.0;
            settings.weatherScale = 1.0;
            settings.appsScale = 1.0;
            
            clockScaleInput.value = 1.0;
            weatherScaleInput.value = 1.0;
            appsScaleInput.value = 1.0;
            
            clockScaleValue.innerText = "100%";
            weatherScaleValue.innerText = "100%";
            appsScaleValue.innerText = "100%";
            
            applySettings();
            saveSettings();
        });

        // --- Fin Event Listeners Scales ---

        showWeatherToggle.addEventListener('change', () => {
            settings.showWeather = showWeatherToggle.checked;
            applySettings();
            saveSettings();
            if (settings.showWeather) fetchWeather();
        });

        updateWeatherBtn.addEventListener('click', () => {
            const city = weatherCityInput.value.trim();
            if (city) {
                settings.weatherCity = city;
                saveSettings();
                fetchWeather();
            }
        });

        weatherCityInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                updateWeatherBtn.click();
            }
        });

        textColorPicker.addEventListener('input', () => {
            settings.textColor = textColorPicker.value;
            applySettings();
        });
        textColorPicker.addEventListener('change', saveSettings);

        resetColorBtn.addEventListener('click', () => {
            settings.textColor = defaultSettings.textColor;
            textColorPicker.value = defaultSettings.textColor;
            applySettings();
            saveSettings();
        });

        fontSelect.addEventListener('change', () => {
            settings.fontFamily = fontSelect.value;
            applySettings();
            saveSettings();
        });

        altBgToggle.addEventListener('change', () => {
            settings.useAlternatingBgs = altBgToggle.checked;
            if (settings.useAlternatingBgs) {
                altBgInputsContainer.classList.remove('hidden');
            } else {
                altBgInputsContainer.classList.add('hidden');
            }
            applySettings();
            saveSettings();
        });
        
        setBgBtn.addEventListener('click', () => {
            const url = bgUrlInput.value.trim();
            if (url) {
                settings.bgUrl = url;
                settings.useAlternatingBgs = false;
                altBgToggle.checked = false;
                altBgInputsContainer.classList.add('hidden');
                applySettings();
                saveSettings();
                settingsPanel.classList.add('hidden');
            }
        });

        bgFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    settings.bgUrl = e.target.result;
                    settings.useAlternatingBgs = false;
                    altBgToggle.checked = false;
                    altBgInputsContainer.classList.add('hidden');
                    applySettings();
                    saveSettings();
                };
                reader.readAsDataURL(file);
                settingsPanel.classList.add('hidden');
            }
        });

        resetBgBtn.addEventListener('click', () => {
            settings.bgUrl = defaultSettings.bgUrl;
            settings.useAlternatingBgs = false;
            altBgToggle.checked = false;
            altBgInputsContainer.classList.add('hidden');
            bgUrlInput.value = '';
            bgFileInput.value = null;
            applySettings();
            saveSettings();
            settingsPanel.classList.add('hidden');
        });

        fullscreenBtn.addEventListener('click', toggleFullScreen);
        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch((err) => {
                    console.error(`Error al intentar entrar en pantalla completa: ${err.message}`);
                });
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }
        
        const expandSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-expand"><path d="m21 21-6-6m6 6v-4.8m0 4.8h-4.8"/><path d="M3 16.2V21h4.8"/><path d="M3 12.6V7.8A4.8 4.8 0 0 1 7.8 3h4.8"/><path d="M16.2 3H21v4.8"/></svg>`;
        const compressSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-shrink"><path d="m15 15 6 6m-6-6v4.8m0-4.8h4.8"/><path d="M9 19.8V15H4.2"/><path d="M9 4.2V9H4.2"/><path d="M19.8 9H15V4.2"/></svg>`;

        document.addEventListener('fullscreenchange', () => {
            const isFullscreen = !!document.fullscreenElement;
            if (isFullscreen) {
                fullscreenBtn.innerHTML = compressSvg;
                fullscreenBtn.classList.add('opacity-0');
                fullscreenBtn.classList.remove('opacity-50');
            } else {
                fullscreenBtn.innerHTML = expandSvg;
                fullscreenBtn.classList.remove('opacity-0');
                fullscreenBtn.classList.add('opacity-50');
            }
        });

        try {
            loadSettings();
        } catch (e) {
            console.error("Error al cargar configuración:", e);
            localStorage.removeItem('clockSettingsV17');
            applySettings();
        }
        
        updateClock();
        setInterval(updateClock, 1000);
        setInterval(fetchWeather, 5 * 60 * 1000);

    </script>
</body>
</html>
